package com.blog.afaq.controller;

import com.blog.afaq.dto.response.RessourceResponse;
import com.blog.afaq.model.*;
import com.blog.afaq.service.RessourceService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.core.io.InputStreamResource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.net.URL;
import java.net.URLConnection;
import java.util.Arrays;
import java.util.List;

@RestController
@RequestMapping("/api/ressources")
@RequiredArgsConstructor
@Slf4j
public class RessourceController {

    private final RessourceService service;

    @PostMapping("/upload")
    public ResponseEntity<RessourceResponse> upload(
            @RequestParam MultipartFile file,
            @RequestParam String titre,
            @RequestParam String description,
            @RequestParam ResourceCategory category,
            @RequestParam(required = false) ResourceSubCategory subCategory,
            @RequestParam FileType fileType,
            @RequestParam Language language
    ) {
        RessourceResponse response = service.uploadRessource(file, titre, description, category,subCategory, fileType, language);
        log.info("ðŸ“¤ Ressource uploaded: {}", response.getId());
        return ResponseEntity.ok(response);
    }

    @GetMapping
    public ResponseEntity<List<RessourceResponse>> getAll() {
        List<RessourceResponse> ressources = service.getAll();
        return ResponseEntity.ok(ressources);
    }

    @GetMapping("/{id}")
    public ResponseEntity<RessourceResponse> getById(@PathVariable String id) {
        Ressource r = service.getEntityById(id);
        return ResponseEntity.ok(service.getAll().stream()
                .filter(res -> res.getId().equals(r.getId()))
                .findFirst()
                .orElseThrow());
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> delete(@PathVariable String id) {
        service.delete(id);
        log.info("ðŸ—‘ Ressource deleted: {}", id);
        return ResponseEntity.noContent().build();
    }

    @GetMapping(params = "lang")
    public ResponseEntity<List<RessourceResponse>> getByLanguage(@RequestParam String lang) {
        return ResponseEntity.ok(service.getByLanguage(lang));
    }

    @GetMapping("/download/{id}")
    public ResponseEntity<InputStreamResource> download(@PathVariable String id) throws IOException {
        InputStreamResource stream = service.getFileStream(id);
        MediaType mediaType = service.getMediaType(service.getEntityById(id));
        String filename = service.getOriginalFilename(id);

        return ResponseEntity.ok()
                .contentType(mediaType)
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + filename + "\"")
                .body(stream);
    }

    @GetMapping("/preview/{id}")
    public ResponseEntity<InputStreamResource> preview(@PathVariable String id) throws IOException {
        InputStreamResource stream = service.getFileStream(id);
        MediaType mediaType = service.getMediaType(service.getEntityById(id));

        return ResponseEntity.ok()
                .contentType(mediaType)
                .header(HttpHeaders.CONTENT_DISPOSITION, "inline")
                .body(stream);
    }

    @GetMapping("/categories")
    public ResponseEntity<List<String>> getCategories() {
        List<String> categories = Arrays.stream(ResourceCategory.values())
                .map(Enum::name)
                .toList();
        return ResponseEntity.ok(categories);
    }

}
