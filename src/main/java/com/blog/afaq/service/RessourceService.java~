package com.blog.afaq.service;

import com.blog.afaq.dto.response.RessourceResponse;
import com.blog.afaq.exception.ResourceNotFoundException;
import com.blog.afaq.model.*;
import com.blog.afaq.repository.RessourceRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.core.io.InputStreamResource;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import java.net.URL;
import java.net.URLConnection;
import java.io.IOException;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

@Service
@RequiredArgsConstructor
public class RessourceService {

    private final CloudinaryService cloudinaryService;
    private final RessourceRepository repository;
    private final NewsletterService newsletterService;

    public RessourceResponse uploadRessource(
            MultipartFile file,
            String titre,
            String description,
            ResourceCategory category,
            ResourceSubCategory subCategory,
            String subSubCategoryName, // still pass string from UI
            FileType fileType,
            Language language
    ) {
        // Validate category â†” subcategory
        if (subCategory != null && subCategory.getParentCategory() != category) {
            throw new IllegalArgumentException("Subcategory does not belong to selected category");
        }

        ResourceSubCategory.NationalSubCategory nationalSubCategory = null;

        // Validate sub-subcategory if NATIONAL
        if (subCategory == ResourceSubCategory.NATIONAL) {
            if (subSubCategoryName == null) {
                throw new IllegalArgumentException("Sub-subcategory is required for NATIONAL");
            }

            try {
                nationalSubCategory = ResourceSubCategory.NationalSubCategory.valueOf(subSubCategoryName.toUpperCase());
            } catch (IllegalArgumentException e) {
                throw new IllegalArgumentException("Invalid sub-subcategory for NATIONAL");
            }
        }

        String fileUrl = cloudinaryService.uploadFile(file, fileType.name());

        Ressource ressource = Ressource.builder()
                .titre(titre)
                .description(description)
                .category(category)
                .subCategory(subCategory)
                .subSubCategory(nationalSubCategory)
                .fileType(fileType)
                .language(language)
                .size(file.getSize())
                .fileUrl(fileUrl)
                .originalFilename(file.getOriginalFilename())
                .createdAt(new Date())
                .build();

        repository.save(ressource);

        return toDto(ressource);
    }





    public RessourceResponse getById(String id) {
        Ressource ressource = repository.findById(id) .
            orElseThrow(() -> new RuntimeException("Ressource not found"));
        return toDto(ressource);
    }

    public List<Ressource> search(String query) {
        return repository.searchByTitreOrDescription(query);
    }
    public long getTotalResources() {
        return repository.count();
    }
    public Ressource getEntityById(String id) {
        return repository.findById(id)
                .orElseThrow(() -> new ResourceNotFoundException("Ressource not found with ID: " + id));
    }

    public List<RessourceResponse> getAll() {
        return repository.findAll().stream().map(this::toDto).toList();
    }

    public void delete(String id) {
        if (!repository.existsById(id)) {
            throw new ResourceNotFoundException("Ressource not found with ID: " + id);
        }
        repository.deleteById(id);
    }

    public List<RessourceResponse> getByLanguage(String language) {
        return repository.findAll()
                .stream()
                .filter(r -> r.getLanguage().name().equalsIgnoreCase(language))
                .map(this::toDto)
                .toList();
    }

    private RessourceResponse toDto(Ressource r) {
        return RessourceResponse.builder()
                .id(r.getId())
                .titre(r.getTitre())
                .description(r.getDescription())
                .category(r.getCategory())
                .subCategory(r.getSubCategory())
                .fileType(r.getFileType())
                .language(r.getLanguage())
                .size(r.getSize())
                .fileUrl(r.getFileUrl())
                .originalFilename(r.getOriginalFilename())
                .createdAt(r.getCreatedAt())
                .build();
    }

    public InputStreamResource getFileStream(String id) throws IOException {
        Ressource r = getEntityById(id);
        URL url = new URL(r.getFileUrl());
        URLConnection conn = url.openConnection();
        return new InputStreamResource(conn.getInputStream());
    }

    public MediaType getMediaType(Ressource r) {
        return switch (r.getFileType()) {
            case PDF -> MediaType.APPLICATION_PDF;
            case IMAGE -> MediaType.IMAGE_JPEG;
            case VIDEO -> MediaType.valueOf("video/mp4");
            default -> MediaType.APPLICATION_OCTET_STREAM;
        };
    }

    public String getOriginalFilename(String id) {
        Ressource r = getEntityById(id);
        return r.getOriginalFilename();
    }

    public List<ResourceSubCategory> getSubCategoriesByCategory(ResourceCategory category) {
        return Arrays.stream(ResourceSubCategory.values())
                .filter(sc -> sc.getParentCategory() == category)
                .toList();
    }

}
